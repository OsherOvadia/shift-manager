generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Note: SQLite doesn't support enums, so we use String fields
// Valid values are enforced at the application level

model Organization {
  id        String   @id @default(uuid())
  name      String
  timezone  String   @default("Asia/Jerusalem")
  createdAt DateTime @default(now()) @map("created_at")

  users            User[]
  shiftTemplates   ShiftTemplate[]
  weeklySchedules  WeeklySchedule[]
  businessSettings BusinessSettings?
  jobCategories    JobCategory[]

  @@map("organizations")
}

model JobCategory {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  nameHe         String   @map("name_he") // Hebrew name
  color          String   @default("#6366f1") // For UI display
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users        User[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("job_categories")
}

model BusinessSettings {
  id                     String   @id @default(uuid())
  organizationId         String   @unique @map("organization_id")
  weekendDays            String   @default("5,6") @map("weekend_days") // Comma-separated values
  submissionDeadlineDay  Int      @default(4) @map("submission_deadline_day")
  submissionDeadlineHour Int      @default(18) @map("submission_deadline_hour")
  createdAt              DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("business_settings")
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  passwordHash   String   @map("password_hash")
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  role           String   @default("EMPLOYEE") // ADMIN, MANAGER, EMPLOYEE
  employmentType String   @default("FULL_TIME") @map("employment_type") // FULL_TIME, PART_TIME
  organizationId String   @map("organization_id")
  jobCategoryId  String?  @map("job_category_id")
  hourlyWage     Float    @default(0) @map("hourly_wage")
  isActive       Boolean  @default(true) @map("is_active")
  isApproved     Boolean  @default(false) @map("is_approved") // For signup approval
  createdAt      DateTime @default(now()) @map("created_at")

  organization            Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  jobCategory             JobCategory?             @relation(fields: [jobCategoryId], references: [id])
  availabilitySubmissions AvailabilitySubmission[]
  shiftAssignments        ShiftAssignment[]
  notifications           Notification[]
  createdSchedules        WeeklySchedule[]

  @@index([organizationId])
  @@index([email])
  @@index([jobCategoryId])
  @@map("users")
}

model ShiftTemplate {
  id             String  @id @default(uuid())
  organizationId String  @map("organization_id")
  name           String
  shiftType      String  @map("shift_type") // MORNING, EVENING, EVENING_CLOSE
  startTime      String  @map("start_time")
  endTime        String  @map("end_time")
  minStaff       Int     @default(1) @map("min_staff")
  maxStaff       Int     @default(10) @map("max_staff")
  isActive       Boolean @default(true) @map("is_active")

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  shiftAssignments ShiftAssignment[]

  @@index([organizationId])
  @@map("shift_templates")
}

model WeeklySchedule {
  id             String    @id @default(uuid())
  organizationId String    @map("organization_id")
  weekStartDate  DateTime  @map("week_start_date")
  status         String    @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  createdById    String    @map("created_by_id")
  publishedAt    DateTime? @map("published_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy        User              @relation(fields: [createdById], references: [id])
  shiftAssignments ShiftAssignment[]

  @@unique([organizationId, weekStartDate])
  @@index([organizationId])
  @@index([weekStartDate])
  @@map("weekly_schedules")
}

model AvailabilitySubmission {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  weekStartDate DateTime  @map("week_start_date")
  status        String    @default("PENDING") // PENDING, APPROVED, REJECTED, REQUIRES_CHANGES
  submittedAt   DateTime? @map("submitted_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  user  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  slots AvailabilitySlot[]

  @@unique([userId, weekStartDate])
  @@index([userId])
  @@index([weekStartDate])
  @@map("availability_submissions")
}

model AvailabilitySlot {
  id             String   @id @default(uuid())
  submissionId   String   @map("submission_id")
  shiftDate      DateTime @map("shift_date")
  shiftType      String   @map("shift_type") // MORNING, EVENING, EVENING_CLOSE
  preferenceRank Int      @default(1) @map("preference_rank")

  submission AvailabilitySubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, shiftDate, shiftType])
  @@index([submissionId])
  @@map("availability_slots")
}

model ShiftAssignment {
  id              String   @id @default(uuid())
  scheduleId      String   @map("schedule_id")
  userId          String   @map("user_id")
  shiftTemplateId String   @map("shift_template_id")
  shiftDate       DateTime @map("shift_date")
  status          String   @default("PENDING") // PENDING, CONFIRMED, CANCELLED
  createdAt       DateTime @default(now()) @map("created_at")

  schedule      WeeklySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  shiftTemplate ShiftTemplate  @relation(fields: [shiftTemplateId], references: [id])

  @@unique([scheduleId, userId, shiftDate, shiftTemplateId])
  @@index([scheduleId])
  @@index([userId])
  @@index([shiftDate])
  @@map("shift_assignments")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String
  message   String
  type      String // SCHEDULE_PUBLISHED, SHIFT_APPROVED, SHIFT_REJECTED, SHIFT_CHANGED, SUBMISSION_REMINDER, RULE_VIOLATION
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("notifications")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

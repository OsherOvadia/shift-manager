// Production schema for Neon PostgreSQL
// Copy this to schema.prisma when deploying to production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For Neon connection pooling
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
}

enum ShiftType {
  MORNING
  EVENING
  EVENING_CLOSE
}

enum ScheduleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
  REQUIRES_CHANGES
}

enum AssignmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum NotificationType {
  SCHEDULE_PUBLISHED
  SHIFT_APPROVED
  SHIFT_REJECTED
  SHIFT_CHANGED
  SUBMISSION_REMINDER
  RULE_VIOLATION
}

model Organization {
  id        String   @id @default(uuid())
  name      String   @unique
  timezone  String   @default("Asia/Jerusalem")
  createdAt DateTime @default(now()) @map("created_at")

  users            User[]
  shiftTemplates   ShiftTemplate[]
  weeklySchedules  WeeklySchedule[]
  businessSettings BusinessSettings?
  jobCategories    JobCategory[]
  cookWeeklyHours  CookWeeklyHours[]
  monthlyExpenses  MonthlyExpenses[]

  @@map("organizations")
}

model JobCategory {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  nameHe         String   @map("name_he")
  color          String   @default("#6366f1")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users        User[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("job_categories")
}

model BusinessSettings {
  id                     String   @id @default(uuid())
  organizationId         String   @unique @map("organization_id")
  weekendDays            Int[]    @default([5, 6]) @map("weekend_days")
  submissionDeadlineDay  Int      @default(4) @map("submission_deadline_day")
  submissionDeadlineHour Int      @default(18) @map("submission_deadline_hour")
  closedPeriods          Json?    @default("[]") @map("closed_periods")
  defaultHourlyWage      Float    @default(30) @map("default_hourly_wage")
  defaultWages           Json?    @default("{}") @map("default_wages")
  shiftRequirements      Json?    @default("{}") @map("shift_requirements")
  enabledShiftTypes      Json?    @default("[\"MORNING\",\"EVENING\"]") @map("enabled_shift_types")
  createdAt              DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("business_settings")
}

model User {
  id             String         @id @default(uuid())
  email          String         @unique
  passwordHash   String         @map("password_hash")
  firstName      String         @map("first_name")
  lastName       String         @map("last_name")
  role           Role           @default(EMPLOYEE)
  employmentType EmploymentType @default(FULL_TIME) @map("employment_type")
  organizationId String         @map("organization_id")
  jobCategoryId  String?        @map("job_category_id")
  hourlyWage     Float          @default(0) @map("hourly_wage")
  baseHourlyWage Float?         @map("base_hourly_wage") // For tip-based employees (waiters)
  isTipBased     Boolean        @default(false) @map("is_tip_based") // Whether salary is tip-based
  isActive       Boolean        @default(true) @map("is_active")
  isApproved     Boolean        @default(false) @map("is_approved")
  createdAt      DateTime       @default(now()) @map("created_at")

  organization            Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  jobCategory             JobCategory?             @relation(fields: [jobCategoryId], references: [id])
  availabilitySubmissions AvailabilitySubmission[]
  shiftAssignments        ShiftAssignment[]
  notifications           Notification[]
  createdSchedules        WeeklySchedule[]
  cookWeeklyHours         CookWeeklyHours[]

  @@index([organizationId])
  @@index([email])
  @@index([jobCategoryId])
  @@map("users")
}

model ShiftTemplate {
  id             String    @id @default(uuid())
  organizationId String    @map("organization_id")
  name           String
  shiftType      ShiftType @map("shift_type")
  startTime      String    @map("start_time")
  endTime        String    @map("end_time")
  minStaff       Int       @default(1) @map("min_staff")
  maxStaff       Int       @default(10) @map("max_staff")
  isActive       Boolean   @default(true) @map("is_active")

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  shiftAssignments ShiftAssignment[]

  @@index([organizationId])
  @@map("shift_templates")
}

model WeeklySchedule {
  id             String         @id @default(uuid())
  organizationId String         @map("organization_id")
  weekStartDate  DateTime       @map("week_start_date") @db.Date
  status         ScheduleStatus @default(DRAFT)
  createdById    String         @map("created_by_id")
  publishedAt    DateTime?      @map("published_at")
  createdAt      DateTime       @default(now()) @map("created_at")

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy        User              @relation(fields: [createdById], references: [id])
  shiftAssignments ShiftAssignment[]

  @@unique([organizationId, weekStartDate])
  @@index([organizationId])
  @@index([weekStartDate])
  @@map("weekly_schedules")
}

model AvailabilitySubmission {
  id            String           @id @default(uuid())
  userId        String           @map("user_id")
  weekStartDate DateTime         @map("week_start_date") @db.Date
  status        SubmissionStatus @default(PENDING)
  submittedAt   DateTime?        @map("submitted_at")
  createdAt     DateTime         @default(now()) @map("created_at")

  user  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  slots AvailabilitySlot[]

  @@unique([userId, weekStartDate])
  @@index([userId])
  @@index([weekStartDate])
  @@map("availability_submissions")
}

model AvailabilitySlot {
  id             String    @id @default(uuid())
  submissionId   String    @map("submission_id")
  shiftDate      DateTime  @map("shift_date") @db.Date
  shiftType      ShiftType @map("shift_type")
  preferenceRank Int       @default(1) @map("preference_rank")

  submission AvailabilitySubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, shiftDate, shiftType])
  @@index([submissionId])
  @@map("availability_slots")
}

model ShiftAssignment {
  id              String           @id @default(uuid())
  scheduleId      String           @map("schedule_id")
  userId          String           @map("user_id")
  shiftTemplateId String           @map("shift_template_id")
  shiftDate       DateTime         @map("shift_date") @db.Date
  status          AssignmentStatus @default(PENDING)
  cashTips        Float?           @default(0) @map("cash_tips") // Cash tips received during shift
  tipsEarned      Float?           @default(0) @map("tips_earned") // Total tips for this shift
  sittingTips     Float?           @default(0) @map("sitting_tips") // Tips from dine-in
  takeawayTips    Float?           @default(0) @map("takeaway_tips") // Tips from takeaway
  deliveryTips    Float?           @default(0) @map("delivery_tips") // Tips from delivery
  actualStartTime String?          @map("actual_start_time") // "HH:MM" format - actual clock-in
  actualEndTime   String?          @map("actual_end_time") // "HH:MM" format - actual clock-out
  actualHours     Float?           @map("actual_hours") // Calculated or manual override
  createdAt       DateTime         @default(now()) @map("created_at")

  schedule      WeeklySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  shiftTemplate ShiftTemplate  @relation(fields: [shiftTemplateId], references: [id])

  @@unique([scheduleId, userId, shiftDate, shiftTemplateId])
  @@index([scheduleId])
  @@index([userId])
  @@index([shiftDate])
  @@map("shift_assignments")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("notifications")
}

model DailyRevenue {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  date            DateTime @db.Date
  totalRevenue    Float    @map("total_revenue")
  sittingRevenue  Float    @default(0) @map("sitting_revenue")
  takeawayRevenue Float    @default(0) @map("takeaway_revenue")
  deliveryRevenue Float    @default(0) @map("delivery_revenue")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, date])
  @@index([organizationId])
  @@index([date])
  @@map("daily_revenues")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model CookWeeklyHours {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  weekStart      DateTime @map("week_start") @db.Date
  totalHours     Float    @map("total_hours")
  hourlyWage     Float    @map("hourly_wage")
  totalEarnings  Float    @map("total_earnings")
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId, weekStart])
  @@index([organizationId])
  @@index([userId])
  @@index([weekStart])
  @@map("cook_weekly_hours")
}

model MonthlyExpenses {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  year           Int
  month          Int      // 1-12
  foodCosts      Float    @default(0) @map("food_costs")
  extras         Float    @default(0) @map("extras")
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, year, month])
  @@index([organizationId])
  @@index([year, month])
  @@map("monthly_expenses")
}
